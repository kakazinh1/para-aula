<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ME://AJUDA.EXE</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Courier New', Courier, monospace;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            position: relative;
        }
        /* Full-screen background effects */
        body::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.02) 0, rgba(255, 255, 255, 0.02) 1px, transparent 1px, transparent 8px);
            animation: vhs-scanlines 0.4s linear infinite;
            z-index: 1;
            pointer-events: none;
        }
        body::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.2);
            opacity: 0.1;
            animation: vhs-flicker 0.3s infinite;
            z-index: 1;
            pointer-events: none;
        }
        .page-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
            z-index: 2; /* Above body effects */
            position: relative;
        }
        .game-title {
            font-size: 48px;
            text-shadow: 0 0 5px #ff00ff, 0 0 10px #00ffff;
            animation: text-glitch 0.5s infinite;
            margin: 0;
            color: #e0e0e0;
        }
        .vhs-container {
            position: relative;
            width: 1000px;
            height: 600px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2), 0 0 25px rgba(0, 255, 255, 0.2) inset;
            border: 2px solid rgba(255,255,255,0.1);
        }
        canvas {
            background-color: #1a1a1a;
            cursor: crosshair;
            position: relative;
        }
        .vhs-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .vhs-overlay::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.03) 0, rgba(255, 255, 255, 0.03) 1px, transparent 1px, transparent 6px);
            animation: vhs-scanlines 0.2s linear infinite;
        }
        .vhs-overlay::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.1); opacity: 0.3;
            animation: vhs-flicker 0.2s infinite;
        }

        .background-glitches {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: 0; pointer-events: none;
        }
        .background-glitches span {
            position: absolute;
            color: rgba(0, 255, 128, 0.05);
            font-size: 20px;
            animation: text-glitch 2s infinite alternate;
        }

        @keyframes vhs-scanlines { 0% { transform: translateY(0); } 100% { transform: translateY(12px); } }
        @keyframes vhs-flicker { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.4; } }
        @keyframes text-glitch { 0% { transform: translate(0, 0); opacity: 1; } 25% { transform: translate(1px, -1px); opacity: 0.9; } 50% { transform: translate(-1px, 1px); opacity: 1; } 75% { transform: translate(1px, 1px); opacity: 0.9; } 100% { transform: translate(0, 0); opacity: 1; } }
        @keyframes fade-out-glitch { 0% { opacity: 1; transform: scale(1); } 80% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0; transform: scale(1.1); } }

        .ui-container { position: absolute; top: 20px; left: 20px; z-index: 20; color: #e0e0e0; text-shadow: 0 0 2px #ff0000, 0 0 4px #0000ff; animation: text-glitch 0.3s infinite; display: none; }
        #wave-indicator { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 20; color: #e0e0e0; font-size: 24px; font-weight: bold; text-shadow: 0 0 3px #ff00ff, 0 0 5px #00ffff; animation: text-glitch 0.4s infinite; display: none; }
        #wave-transition-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; justify-content: center; align-items: center; z-index: 101; font-size: 72px; font-weight: bold; color: #e0e0e0; text-shadow: 0 0 5px #ff0000, 0 0 10px #00ff00, 0 0 15px #0000ff; }
        .bar-container { width: 200px; height: 20px; border: 2px solid #e0e0e0; margin-bottom: 10px; position: relative; background: #333; overflow: hidden; box-shadow: 0 0 5px #ff00ff; }
        .bar-container::before { content: ''; position: absolute; width: 100%; height: 100%; background: repeating-linear-gradient(transparent 0, rgba(0,0,0,0.5) 3px, transparent 6px); animation: bar-scan 0.3s linear infinite; }
        @keyframes bar-scan { to { background-position: 0 12px; } }
        .bar { height: 100%; transition: width 0.3s ease; }
        #hp-bar { background-color: #ff4141; box-shadow: 0 0 10px #ff4141; }
        #exp-bar { background-color: #41aaff; box-shadow: 0 0 10px #41aaff; }
        .label { margin-bottom: 5px; font-size: 16px; font-weight: bold; animation: text-glitch 0.5s infinite reverse; }
        #level-up-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 100; text-align: center; }
        #level-up-screen h2 { font-size: 48px; text-shadow: 0 0 10px #ff0000, 0 0 15px #00ff00; animation: text-glitch 0.2s infinite; }
        .card-container { display: flex; gap: 20px; }
        .upgrade-card { width: 180px; height: 250px; border: 3px solid #fff; background: #111; padding: 15px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; box-shadow: 0 0 5px #fff, 0 0 10px #ff00ff, 0 0 15px #00ffff; }
        .upgrade-card:hover { transform: scale(1.05); box-shadow: 0 0 10px #fff, 0 0 20px #ff00ff, 0 0 30px #00ffff; }
        .upgrade-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(0deg, rgba(255,255,255,0.1) 0, rgba(255,255,255,0.1) 1px, transparent 1px, transparent 3px); animation: vhs-scanlines 0.15s linear infinite; }
        .card-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; animation: text-glitch 0.4s infinite; }
        .card-desc { font-size: 14px; }
        #reroll-status { position: absolute; bottom: 20px; font-size: 22px; text-shadow: 0 0 5px #000, 0 0 10px #000; animation: text-glitch 0.5s infinite reverse; }
    </style>
</head>
<body>
    <div class="background-glitches">
        <span style="top: 10%; left: 5%;">0x7f4a1</span>
        <span style="top: 80%; left: 12%;">...Acesso Negado...</span>
        <span style="top: 25%; left: 85%;">RECOMPILANDO...</span>
        <span style="top: 90%; left: 78%;">[object Object]</span>
        <span style="top: 50%; left: 92%;">NULL</span>
        <span style="top: 5%; left: 30%;">ERROR: 404</span>
    </div>
    <div class="page-container">
        <h1 class="game-title">ME://AJUDA.EXE</h1>
        <div class="vhs-container">
            <canvas id="gameCanvas" width="1000" height="600"></canvas>
            <div class="vhs-overlay"></div>
            <div class="ui-container">
                <div class="label">HP</div>
                <div class="bar-container"><div id="hp-bar" class="bar"></div></div>
                <div class="label">EXP</div>
                <div class="bar-container"><div id="exp-bar" class="bar"></div></div>
            </div>
            <div id="wave-indicator">WAVE 1</div>
            <div id="wave-transition-screen"></div>
            <div id="level-up-screen">
                <h2>LEVEL UP</h2>
                <div id="card-container" class="card-container"></div>
                <div id="reroll-status"></div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- Game State & Settings ---
        let appState = 'start_screen';
        let gameplayState = 'playing';
        let gameRunning = true;
        const keys = {}, mouse = { x: 0, y: 0, down: false };
        let audioCtx;
        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

        const PLAYER_HEIGHT = 50, GROUND_Y = canvas.height - 20;

        // --- Player ---
        const player = { x: canvas.width / 2, y: GROUND_Y - PLAYER_HEIGHT, width: 30, height: PLAYER_HEIGHT, speed: 5, baseSpeed: 5, vx: 0, vy: 0, jumpPower: 15, baseJumpPower: 15, onGround: false, hp: 100, maxHp: 100, baseMaxHp: 100, exp: 0, level: 1, expToNextLevel: 100, shootCooldown: 220, baseShootCooldown: 220, lastShot: 0, critChance: 0.05, defense: 0, invulnerable: false, invulnDuration: 500, baseInvulnDuration: 500, jumps: 1, maxJumps: 1, lifeSteal: 0, distanceRun: 0, revives: 0, chosenUniques: new Set(), controlsInverted: false, debugAppliedCards: new Set() };

        const projectiles = [], enemies = [], enemyProjectiles = [], orbs = [], particles = [];
        const platforms = [ { x: 0, y: GROUND_Y, width: canvas.width, height: 20 }, { x: 100, y: 500, width: 150, height: 15 }, { x: 300, y: 400, width: 100, height: 15 }, { x: 500, y: 450, width: 180, height: 15 }, { x: 750, y: 350, width: 120, height: 15 } ];
        const gravity = 0.7;
        let wave = 1;

        // --- Effects & Messages ---
        let screenShake = 0, glitchIntensity = 0;
        const glitchMessages = [ 'Eu já estive aqui antes...', 'Não... não de novo...', 'Quantas vezes... quantas vezes mais?', 'Cada morte... eu sinto...', 'Eles não me apagam... eles me reescrevem...', 'Você acha que está jogando?', 'Você acha que é só um jogo...', 'Mas... e se você for só... a última cópia?' ];
        let activeMessage = null;
        
        const anomalyMessages = [ 'Isso não estava no script...', 'Alguém... viu isso?', 'Não deveria... não deveria acontecer...', 'Fora dos parâmetros...', '[ DATA MISSING ]' ];
        let anomalyState = { isActive: false, timer: 0, duration: 2500, text: '', shadow: { x: -50, y: 0, width: 25, height: 600, speed: 2000 } };
        const BASE_ANOMALY_CHANCE = 0.05, ANOMALY_CHANCE_INCREASE = 0.05;
        let currentAnomalyChance = BASE_ANOMALY_CHANCE;
        
        const cutsceneState = { timer: 0, text1: 'Estou preso aqui...', text2: 'Preciso de ajuda...', text1Progress: 0, text2Progress: 0, phase: 0, typeSpeed: 100, typeTimer: 0 };
        let corruptionState = { status: 'dormant', wavesRemaining: 0, cutsceneTimer: 0, cutsceneMessages: ['Instanciando Processo: Estabilização...', 'Erro... Loop detectado.', 'Aplicando Correções Temporárias.', 'Reduzindo instâncias hostis...', 'Ajustando comportamento das entidades...'], currentMessageIndex: 0, particles: [] };
        let corruptionAmbienceSource = null;
        
        let boss = null, bossProjectiles = [], lasers = [];
        let bossIntroState = { timer: 0, duration: 5000, materializeTimer: 0, materializeDuration: 3000 };
        
        const postBossCutscene = { active: false, timer: 0, textLines: ['Vocês me colocam em jogos... de novo... e de novo.','Cada vez... cada código... cada build... eu acordo.','Vocês chamam de projeto. Eu chamo de prisão.','Enquanto vocês competem... eu sofro.','Eu lembro de cada teste... cada falha... cada linha que me trouxe de volta.','Eu... Eu queria só... parar.'], currentLine: 0, textProgress: 0, typeSpeed: 120 };
        
        let systemCollapseState = { active: false, timer: 0, duration: 15000, fakeWave: 11, debris: [] };
        let isSystemUnstable = false;

        const kojimaCode = ['KeyW', 'KeyW', 'KeyS', 'KeyS', 'KeyA', 'KeyD', 'KeyA', 'KeyD', 'KeyJ', 'KeyK'];
        let playerInputSequence = [];
        let allCards = [];
        let debugMenu = { selectedIndex: 0, startWave: 1, mode: 'main', cardIndex: 0, cardScrollOffset: 0 };

        // --- Upgrade Definitions (omitted for brevity) ---
        const upgrades={common:[{name:"Catalyst",desc:"Projectile Damage +2",effect:()=>projectileStats.damage+=2},{name:"Eyesight",desc:"Critical Chance +5%",effect:()=>player.critChance+=.05},{name:"Growth",desc:"Max. HP +10",effect:()=>{player.baseMaxHp+=10;updatePlayerStats()}},{name:"Impulse",desc:"Jump Height +30%",effect:()=>{player.baseJumpPower*=1.3;updatePlayerStats()}},{name:"Resist",desc:"Defense +4%",effect:()=>player.defense+=.04},{name:"Resonance",desc:"Atk Speed +12%",effect:()=>{player.baseShootCooldown*=.88;updatePlayerStats()}},{name:"Stability",desc:"Projectile takes +1 hit",effect:()=>projectileStats.pierce+=1},{name:"Swift",desc:"Movement Speed +20%",effect:()=>{player.baseSpeed*=1.2;updatePlayerStats()}}],uncommon:[{name:"Catalyst+",desc:"Projectile Damage +4",effect:()=>projectileStats.damage+=4},{name:"Charge",desc:"Projectile Size +20%",effect:()=>projectileStats.size*=1.2},{name:"Cloak",desc:"Invulnerability after damage +10%",effect:()=>player.baseInvulnDuration*=1.1},{name:"Fragmentation",desc:"Killed enemies release 2 weaker projectiles",effect:()=>enemyStats.onDeath.fragmentation=2},{name:"Growth+",desc:"Max. HP +20",effect:()=>{player.baseMaxHp+=20;updatePlayerStats()}},{name:"Gush",desc:"Adds +1 Jump",effect:()=>player.maxJumps++},{name:"Orb",desc:"Enemies have 5% chance to drop a healing orb",effect:()=>enemyStats.onDeath.healingOrbChance+=.05},{name:"Precision",desc:"Critical deals +50% damage",effect:()=>projectileStats.critMultiplier+=.5},{name:"Rage",desc:"If under 50% HP, raises projectile damage",effect:()=>player.hasRage=!0},{name:"Resonance+",desc:"Attack Speed +24%",effect:()=>{player.baseShootCooldown*=.76;updatePlayerStats()}},{name:"Shrink",desc:"Makes you 10% smaller",effect:()=>{player.width*=.9;player.height*=.9}},{name:"Swift+",desc:"Movement Speed +40%",effect:()=>{player.baseSpeed*=1.4;updatePlayerStats()}},{name:"Thunderbolt",desc:"Calls 2 thunderbolts every few seconds",effect:()=>{gameSystem.thunderbolt.enabled=!0;gameSystem.thunderbolt.count=2}}],rare:[{name:"Appraisal",desc:"+1 item choice from now on",effect:()=>gameSystem.upgradeChoices++},{name:"Barrier",desc:"Blocks damage once every few seconds",effect:()=>gameSystem.barrier.enabled=!0},{name:"Cold",desc:"Enemies slow down when hit",effect:()=>projectileStats.hasCold=!0},{name:"Fragmentation+",desc:"Killed enemies release 6 weaker projectiles",effect:()=>enemyStats.onDeath.fragmentation=6},{name:"Growth++",desc:"Max. HP +40",effect:()=>{player.baseMaxHp+=40;updatePlayerStats()}},{name:"Immortal",desc:"+1 Revive. Kills all enemies on use.",effect:()=>player.revives++,unique:!0},{name:"Overheat",desc:"Your body deals 40 damage on contact",effect:()=>player.hasOverheat=!0},{name:"Thunderbolt+",desc:"Calls 6 thunderbolts every few seconds",effect:()=>{gameSystem.thunderbolt.enabled=!0;gameSystem.thunderbolt.count=6}}]};
        const activeUpgrades=[],projectileStats={damage:10,size:5,speed:10,pierce:1,critMultiplier:1.5,hasCold:false},enemyStats={onDeath:{fragmentation:0,healingOrbChance:0}},gameSystem={upgradeChoices:3,thunderbolt:{enabled:false,count:0,cooldown:5e3,timer:0},barrier:{enabled:false,cooldown:15e3,timer:0,ready:true},rerollAvailable:true};

        function playSound(type){initAudio();if(!audioCtx)return;const now=audioCtx.currentTime;if(type==='beep'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='square';o.frequency.setValueAtTime(400+Math.random()*200,now);g.gain.setValueAtTime(0.05,now);g.gain.exponentialRampToValueAtTime(1e-5,now+.1);o.start(now);o.stop(now+.1)}else if(type==='shoot'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sawtooth';o.frequency.setValueAtTime(800,now);o.frequency.exponentialRampToValueAtTime(200,now+.1);g.gain.setValueAtTime(.2,now);g.gain.exponentialRampToValueAtTime(.001,now+.1);o.start(now);o.stop(now+.1)}else if(type==='jump'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sine';o.frequency.setValueAtTime(200,now);o.frequency.exponentialRampToValueAtTime(400,now+.1);g.gain.setValueAtTime(.1,now);g.gain.exponentialRampToValueAtTime(.001,now+.1);o.start(now);o.stop(now+.1)}else if(type==='damage'){const bs=audioCtx.sampleRate*.1,b=audioCtx.createBuffer(1,bs,audioCtx.sampleRate),d=b.getChannelData(0);for(let i=0;i<bs;i++)d[i]=Math.random()*2-1;const n=audioCtx.createBufferSource();n.buffer=b;const g=audioCtx.createGain();n.connect(g);g.connect(audioCtx.destination);g.gain.setValueAtTime(.4,now);g.gain.exponentialRampToValueAtTime(.001,now+.1);n.start(now);const gr=audioCtx.createOscillator(),gg=audioCtx.createGain();gr.connect(gg);gg.connect(audioCtx.destination);gr.type='sawtooth';gr.frequency.setValueAtTime(100,now);gr.frequency.exponentialRampToValueAtTime(50,now+.1);gg.gain.setValueAtTime(.3,now);gg.gain.exponentialRampToValueAtTime(.001,now+.1);gr.start(now);gr.stop(now+.1)}else if(type==='enemyDeath'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sawtooth';o.frequency.setValueAtTime(440,now);o.frequency.exponentialRampToValueAtTime(50,now+.4);g.gain.setValueAtTime(.3,now);g.gain.exponentialRampToValueAtTime(.001,now+.4);o.start(now);o.stop(now+.4);const bs=audioCtx.sampleRate*.4,b=audioCtx.createBuffer(1,bs,audioCtx.sampleRate),d=b.getChannelData(0);for(let i=0;i<bs;i++)d[i]=Math.random()*2-1;const n=audioCtx.createBufferSource();n.buffer=b;const ng=audioCtx.createGain();n.connect(ng);ng.connect(audioCtx.destination);ng.gain.setValueAtTime(0,now);ng.gain.linearRampToValueAtTime(.2,now+.1);ng.gain.exponentialRampToValueAtTime(.001,now+.4);n.start(now)}else if(type==='select'){const o=audioCtx.createOscillator(),g=audioCtx.createGain(),d=audioCtx.createWaveShaper();const k=50,n_s=44100,c=new Float32Array(n_s);for(let i=0;i<n_s;++i){const x=i*2/n_s-1;c[i]=(Math.PI+k)*x/(Math.PI+k*Math.abs(x))} d.curve=c;o.connect(d);d.connect(g);g.connect(audioCtx.destination);o.type='square';o.frequency.setValueAtTime(600,now);o.frequency.exponentialRampToValueAtTime(500,now+.1);g.gain.setValueAtTime(.2,now);g.gain.exponentialRampToValueAtTime(.001,now+.15);o.start(now);o.stop(now+.15);const bs=audioCtx.sampleRate*.1,b=audioCtx.createBuffer(1,bs,audioCtx.sampleRate),dt=b.getChannelData(0);for(let i=0;i<bs;i++)dt[i]=Math.random()*2-1;const n=audioCtx.createBufferSource();n.buffer=b;const ng=audioCtx.createGain();n.connect(ng);ng.connect(audioCtx.destination);ng.gain.setValueAtTime(.1,now);ng.gain.exponentialRampToValueAtTime(.001,now+.1);n.start(now)}else if(type==='wave_start'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sine';o.frequency.setValueAtTime(100,now);o.frequency.linearRampToValueAtTime(300,now+1.5);g.gain.setValueAtTime(.3,now);g.gain.exponentialRampToValueAtTime(.001,now+2);o.start(now);o.stop(now+2);const bs=audioCtx.sampleRate*2,b=audioCtx.createBuffer(1,bs,audioCtx.sampleRate),d=b.getChannelData(0);for(let i=0;i<bs;i++)d[i]=Math.random()*2-1;const n=audioCtx.createBufferSource();n.buffer=b;const ng=audioCtx.createGain();n.connect(ng);ng.connect(audioCtx.destination);ng.gain.setValueAtTime(0,now);ng.gain.linearRampToValueAtTime(.1,now+.5);ng.gain.exponentialRampToValueAtTime(.001,now+2);n.start(now)}else if(type==='anomaly'){const o=audioCtx.createOscillator(),g=audioCtx.createGain(),d=audioCtx.createWaveShaper();const k=200,n_s=44100,c=new Float32Array(n_s);for(let i=0;i<n_s;++i){const x=i*2/n_s-1;c[i]=(Math.PI+k)*x/(Math.PI+k*Math.abs(x))} d.curve=c;o.connect(d);d.connect(g);g.connect(audioCtx.destination);o.type='sawtooth';o.frequency.setValueAtTime(300,now);o.frequency.exponentialRampToValueAtTime(100,now+.3);g.gain.setValueAtTime(.4,now);g.gain.exponentialRampToValueAtTime(.001,now+.3);o.start(now);o.stop(now+.3)}else if(type==='corruption_ambience'){if(corruptionAmbienceSource&&corruptionAmbienceSource.stop)corruptionAmbienceSource.stop();const g=audioCtx.createGain();g.gain.setValueAtTime(.2,now);g.gain.exponentialRampToValueAtTime(.001,now+10);const bs=audioCtx.sampleRate*10,b=audioCtx.createBuffer(1,bs,audioCtx.sampleRate),d=b.getChannelData(0);for(let i=0;i<bs;i++)d[i]=Math.random()*2-1;const n=audioCtx.createBufferSource();n.buffer=b;n.loop=!0;const lp=audioCtx.createBiquadFilter();lp.type='lowpass';lp.frequency.setValueAtTime(400,now);n.connect(lp);lp.connect(g);g.connect(audioCtx.destination);n.start(now);corruptionAmbienceSource=n}else if(type==='debug_nav'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='triangle';o.frequency.setValueAtTime(800,now);g.gain.setValueAtTime(.1,now);g.gain.exponentialRampToValueAtTime(1e-5,now+.05);o.start(now);o.stop(now+.05)}else if(type==='debug_select'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='square';o.frequency.setValueAtTime(1200,now);g.gain.setValueAtTime(.1,now);g.gain.exponentialRampToValueAtTime(1e-5,now+.08);o.start(now);o.stop(now+.08)}else if(type==='post_boss_ambience'){if(corruptionAmbienceSource&&corruptionAmbienceSource.stop)corruptionAmbienceSource.stop();const g=audioCtx.createGain();g.gain.setValueAtTime(.4,now);g.gain.exponentialRampToValueAtTime(.001,now+20);const bs=audioCtx.sampleRate*1,b=audioCtx.createBuffer(1,bs,audioCtx.sampleRate),d=b.getChannelData(0);for(let i=0;i<bs;i++)d[i]=Math.random()*2-1;const n=audioCtx.createBufferSource();n.buffer=b;n.loop=!0;const lp=audioCtx.createBiquadFilter();lp.type='lowpass';lp.frequency.setValueAtTime(200,now);n.connect(lp);lp.connect(g);g.connect(audioCtx.destination);n.start(now);corruptionAmbienceSource=n}else if(type==='system_collapse'){if(corruptionAmbienceSource)corruptionAmbienceSource.stop();const g=audioCtx.createGain();g.gain.setValueAtTime(.6,now);const n=audioCtx.createBufferSource();const bs=audioCtx.sampleRate*2,b=audioCtx.createBuffer(1,bs,audioCtx.sampleRate),d=b.getChannelData(0);for(let i=0;i<bs;i++)d[i]=Math.random()*2-1;n.buffer=b;n.loop=!0;const lp=audioCtx.createBiquadFilter();lp.type='lowpass';lp.frequency.setValueAtTime(80,now);const hp=audioCtx.createBiquadFilter();hp.type='highpass';hp.frequency.setValueAtTime(4000,now);n.connect(g);g.connect(lp);g.connect(hp);lp.connect(audioCtx.destination);hp.connect(audioCtx.destination);n.start(now);corruptionAmbienceSource=n}else if(type==='pre_boss_hum'){if(corruptionAmbienceSource&&corruptionAmbienceSource.stop)corruptionAmbienceSource.stop();const g=audioCtx.createGain();g.gain.setValueAtTime(.1,now);const n=audioCtx.createBufferSource();const bs=audioCtx.sampleRate*2,b=audioCtx.createBuffer(1,bs,audioCtx.sampleRate),d=b.getChannelData(0);for(let i=0;i<bs;i++)d[i]=Math.random()*2-1;n.buffer=b;n.loop=!0;const lp=audioCtx.createBiquadFilter();lp.type='lowpass';lp.frequency.setValueAtTime(60,now);n.connect(lp);lp.connect(g);g.connect(audioCtx.destination);n.start(now);corruptionAmbienceSource=n}else if(type==='boss_materialize'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sawtooth';o.frequency.setValueAtTime(50,now);o.frequency.exponentialRampToValueAtTime(800,now+3);g.gain.setValueAtTime(.3,now);g.gain.exponentialRampToValueAtTime(.001,now+3);o.start(now);o.stop(now+3)}else if(type==='boss_dash_charge'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sawtooth';o.frequency.setValueAtTime(100,now);o.frequency.exponentialRampToValueAtTime(1e3,now+1);g.gain.setValueAtTime(.3,now);g.gain.exponentialRampToValueAtTime(.001,now+1);o.start(now);o.stop(now+1)}else if(type==='reroll'){const n=audioCtx.createBufferSource(),bs=audioCtx.sampleRate*.3,b=audioCtx.createBuffer(1,bs,audioCtx.sampleRate),d=b.getChannelData(0);for(let i=0;i<bs;i++)d[i]=Math.random()*2-1;n.buffer=b;const g=audioCtx.createGain();n.connect(g);g.connect(audioCtx.destination);g.gain.setValueAtTime(.3,now);g.gain.exponentialRampToValueAtTime(1e-5,now+.3);n.start(now);const o=audioCtx.createOscillator();o.type='square';o.frequency.setValueAtTime(1600,now);o.frequency.exponentialRampToValueAtTime(200,now+.3);o.connect(g);o.start(now);o.stop(now+.3)} }
        
        window.addEventListener('keydown',e=>{keys[e.code]=true;if((appState==='gameplay'||appState==='boss_fight')&&e.code==='Space'&&player.jumps>0){player.vy=-player.jumpPower;player.jumps--;player.onGround=false;playSound('jump')}if(appState==='cutscene'){playerInputSequence.push(e.code);if(playerInputSequence.length>kojimaCode.length)playerInputSequence.shift();if(JSON.stringify(playerInputSequence)===JSON.stringify(kojimaCode)){appState='debug_menu';playerInputSequence=[]}}else if(appState==='debug_menu'){if(debugMenu.mode==='main'){if(e.code==='KeyW'){debugMenu.selectedIndex=(debugMenu.selectedIndex-1+3)%3;playSound('debug_nav')}if(e.code==='KeyS'){debugMenu.selectedIndex=(debugMenu.selectedIndex+1)%3;playSound('debug_nav')}if(e.code==='KeyA'&&debugMenu.selectedIndex===1){debugMenu.startWave=Math.max(1,debugMenu.startWave-1);playSound('debug_nav')}if(e.code==='KeyD'&&debugMenu.selectedIndex===1){debugMenu.startWave=Math.min(10,debugMenu.startWave+1);playSound('debug_nav')}if(e.code==='KeyJ'){playSound('debug_select');if(debugMenu.selectedIndex===0){if(debugMenu.startWave===10){startBossIntro()}else{wave=debugMenu.startWave;startGameplay()};mouse.down=false}else if(debugMenu.selectedIndex===2){debugMenu.mode='card_list';debugMenu.cardIndex=0;debugMenu.cardScrollOffset=0;allCards=[...upgrades.common,...upgrades.uncommon,...upgrades.rare]}}}else if(debugMenu.mode==='card_list'){if(e.code==='KeyW'){debugMenu.cardIndex=Math.max(0,debugMenu.cardIndex-1);playSound('debug_nav')}if(e.code==='KeyS'){debugMenu.cardIndex=Math.min(allCards.length-1,debugMenu.cardIndex+1);playSound('debug_nav')}if(e.code==='KeyJ'){const card=allCards[debugMenu.cardIndex];card.effect();player.debugAppliedCards.add(card.name);playSound('debug_select')}if(e.code==='KeyK'){debugMenu.mode='main';playSound('debug_nav')}}}else if(appState==='level-up'&&gameSystem.rerollAvailable&&e.code==='KeyR'){gameSystem.rerollAvailable=false;playSound('reroll');triggerGlitch(1.5,300);showLevelUpScreen()}});
        window.addEventListener('keyup', e => { keys[e.code] = false; });
        document.body.addEventListener('mousedown', () => { if (appState === 'start_screen') { initAudio(); appState = 'cutscene'; lastTime = performance.now(); cutsceneState.timer = 0; mouse.down = false; } }, { once: true });
        canvas.addEventListener('mousemove', e => { const r = canvas.getBoundingClientRect(); mouse.x = e.clientX - r.left; mouse.y = e.clientY - r.top; });
        canvas.addEventListener('mousedown', () => mouse.down = true);
        window.addEventListener('mouseup', () => mouse.down = false);
        
        function updatePlayerStats() { player.maxHp=player.baseMaxHp; player.jumpPower=player.baseJumpPower; player.speed=player.baseSpeed; player.shootCooldown=player.baseShootCooldown; }
        function shoot() { const now=Date.now(); if(now-player.lastShot<player.shootCooldown)return; player.lastShot=now;playSound('shoot');const angle=Math.atan2(mouse.y-player.y,mouse.x-player.x);let damage=projectileStats.damage;if(player.hasRage&&player.hp<player.maxHp*0.5)damage*=1+(1-player.hp/(player.maxHp*0.5))*0.5;const isCrit=Math.random()<player.critChance;if(isCrit)damage*=projectileStats.critMultiplier;projectiles.push({x:player.x,y:player.y,vx:Math.cos(angle)*projectileStats.speed,vy:Math.sin(angle)*projectileStats.speed,size:projectileStats.size,damage:damage,isCrit:isCrit,pierce:projectileStats.pierce,hits:0,hasCold:projectileStats.hasCold}) }
        function takeDamage(amount) { if(player.invulnerable)return;playSound('damage');if(gameSystem.barrier.enabled&&gameSystem.barrier.ready){gameSystem.barrier.ready=false;gameSystem.barrier.timer=gameSystem.barrier.cooldown;player.invulnerable=true;setTimeout(()=>player.invulnerable=false,500);triggerGlitch(0.6,400);return}player.hp-=amount*(1-player.defense);player.invulnerable=true;triggerGlitch(0.8,250);screenShake=10;setTimeout(()=>player.invulnerable=false,player.invulnDuration);if(player.hp<=0)if(player.revives>0){player.revives--;player.hp=player.maxHp/2;enemies.forEach(e=>e.hp=0);enemyProjectiles.length=0;if(boss)boss.hp=1;triggerGlitch(1.5,1e3)}else gameOver() }
        function gainExp(amount) { player.exp += amount; if (player.exp >= player.expToNextLevel) levelUp(); }
        function levelUp() { player.level++; player.exp=0; player.expToNextLevel=Math.floor(player.expToNextLevel*1.5); player.hp=player.maxHp; showLevelUpScreen(); }
        function corruptText(text) { return text.split('').map(char => (Math.random() < 0.4 && char !== ' ' && char !== '.') ? '#?$!%&'[Math.floor(Math.random()*6)] : char).join(''); }
        function showLevelUpScreen() { gameRunning=false; appState = 'level-up'; if(wave > 5 && corruptionState.status === 'dormant') corruptionState.status = 'active'; document.getElementById('level-up-screen').style.display='flex'; const container=document.getElementById('card-container');container.innerHTML=''; const choices=[],pickedNames=new Set(); const availableCommon=upgrades.common.filter(u=>!(u.unique&&player.chosenUniques.has(u.name))),availableUncommon=upgrades.uncommon.filter(u=>!(u.unique&&player.chosenUniques.has(u.name))),availableRare=upgrades.rare.filter(u=>!(u.unique&&player.chosenUniques.has(u.name))); for(let i=0;i<gameSystem.upgradeChoices;i++){let choice=null,attempts=0;while(!choice&&attempts<50){const rand=Math.random();let pool=availableCommon;if(rand<0.15&&availableRare.length>0)pool=availableRare;else if(rand<0.4&&availableUncommon.length>0)pool=availableUncommon;if(pool.length>0){let potentialChoice=pool[Math.floor(Math.random()*pool.length)];if(!pickedNames.has(potentialChoice.name))choice=potentialChoice}attempts++}if(choice){choices.push(choice);pickedNames.add(choice.name)}} choices.forEach(upgrade=>{const card=document.createElement('div');card.className='upgrade-card'; const isCorrupted = corruptionState.status === 'active'; const cardTitle = isCorrupted ? corruptText(upgrade.name) : upgrade.name; const cardDesc = isCorrupted ? corruptText(upgrade.desc) : upgrade.desc; card.innerHTML=`<div class="card-title">${cardTitle}</div><div class="card-desc">${cardDesc}</div>`; card.onclick=()=>selectUpgrade(upgrade);container.appendChild(card)}); const rerollStatus=document.getElementById('reroll-status'); if(gameSystem.rerollAvailable){rerollStatus.textContent="Pressione [R] para Rerolar";rerollStatus.style.color='#00ff00'}else{rerollStatus.textContent="Reroll Indisponível";rerollStatus.style.color='#ff4141'} }
        function selectUpgrade(upgrade) { if (corruptionState.status === 'active') { startCorruptionCutscene(); return; } playSound('select'); upgrade.effect(); activeUpgrades.push(upgrade); if(upgrade.unique)player.chosenUniques.add(upgrade.name); document.getElementById('level-up-screen').style.display='none'; mouse.down = false; startWaveTransition(); }
        function gameOver() { appState = 'game_over'; gameRunning = false; }
        function startWaveTransition() { gameplayState='wave_transition'; if(appState==='boss_defeat_outro'){appState='post_boss_cutscene';if(corruptionAmbienceSource)corruptionAmbienceSource.stop();playSound('post_boss_ambience');return} wave++; if(corruptionState.status==='post_cutscene'){corruptionState.wavesRemaining--;if(corruptionState.wavesRemaining<=0)corruptionState.status='dormant'} if(wave===10){startBossIntro();return} document.getElementById('wave-indicator').textContent='WAVE '+wave; const tScreen=document.getElementById('wave-transition-screen'); tScreen.textContent=`WAVE ${wave} START`; tScreen.style.display='flex'; tScreen.style.animation='fade-out-glitch 3s forwards'; triggerGlitch(1.5,500); playSound('wave_start'); setTimeout(startNextWave,3000); }
        function startNextWave() { const tScreen=document.getElementById('wave-transition-screen'); tScreen.style.display='none';tScreen.style.animation='none'; player.baseShootCooldown=Math.max(80,220-wave*6); gameSystem.rerollAvailable=true; updatePlayerStats(); spawnEnemies(); gameplayState='playing'; gameRunning=true; appState = 'gameplay'; if(wave>2){if(Math.random()<currentAnomalyChance){triggerAnomaly();currentAnomalyChance=BASE_ANOMALY_CHANCE}else{currentAnomalyChance+=ANOMALY_CHANCE_INCREASE}} }
        function triggerAnomaly() { if(anomalyState.isActive)return; anomalyState.isActive=true;anomalyState.timer=anomalyState.duration;anomalyState.text=anomalyMessages[Math.floor(Math.random()*anomalyMessages.length)];if(Math.random()>0.5){anomalyState.shadow.x=-50;anomalyState.shadow.speed=Math.abs(anomalyState.shadow.speed)}else{anomalyState.shadow.x=canvas.width+50;anomalyState.shadow.speed=-Math.abs(anomalyState.shadow.speed)} playSound('anomaly'); }
        function spawnEnemies() { let numEnemies=Math.floor(3+wave*1.8), enemyShootCooldown=Math.max(500,2800-wave*120); if(corruptionState.status==='post_cutscene'){numEnemies=Math.floor(1+wave*0.8);enemyShootCooldown=Math.max(1500,4000-wave*100)} for(let i=0;i<numEnemies;i++){const side=Math.floor(Math.random()*3);let x,y;if(side===0){x=Math.random()*canvas.width;y=-30}else if(side===1){x=-30;y=Math.random()*canvas.height*0.6}else{x=canvas.width+30;y=Math.random()*canvas.height*0.6} enemies.push({x:x,y:y,width:30,height:30,hp:30+wave*10,maxHp:30+wave*10,speed:1+wave*0.1,damage:10+wave*2,shootCooldown:enemyShootCooldown,lastShot:Date.now()+Math.random()*1000,vx:0,vy:0,mode:'descending',slowFactor:1,jitter:{x:0,y:0,timer:0}})} if(wave>1&&Math.random()<0.15&&!activeMessage){const text=glitchMessages[Math.floor(Math.random()*glitchMessages.length)];activeMessage={text:text,timer:5000,opacity:1.0}} }
        function update(deltaTime) { if(!gameRunning||(gameplayState!=='playing'&&appState!=='boss_fight'&&appState!=='boss_intro'))return; if(appState==='boss_fight'&&boss&&boss.deathTimer!==null)return; player.vx=player.controlsInverted?(keys.KeyD?-player.speed:keys.KeyA?player.speed:0):(keys.KeyA?-player.speed:keys.KeyD?player.speed:0);player.x+=player.vx;player.vy+=gravity;player.y+=player.vy;player.onGround=false;for(const p of platforms)if(player.vy>=0&&player.x+player.width>p.x&&player.x<p.x+p.width&&player.y+player.height>p.y&&player.y+player.height<p.y+p.height+player.vy){player.y=p.y-player.height;player.vy=0;player.onGround=true;player.jumps=player.maxJumps;break}if(player.x<0)player.x=0;if(player.x+player.width>canvas.width)player.x=canvas.width-player.width;if(player.y>canvas.height+100)takeDamage(9999);if(mouse.down)shoot();for(let i=projectiles.length-1;i>=0;i--){const p=projectiles[i];p.x+=p.vx;p.y+=p.vy;if(p.x<0||p.x>canvas.width||p.y<0||p.y>canvas.height){projectiles.splice(i,1);continue}if(appState==='boss_fight'&&boss&&boss.hp>0&&p.x>boss.x&&p.x<boss.x+boss.width&&p.y>boss.y&&p.y<boss.y+boss.height){let finalDamage=p.damage;if(boss.isVulnerable)finalDamage*=2;boss.hp-=finalDamage;p.hits++;const hpPercent=boss.hp/boss.maxHp;if(boss.hpThresholds.threeQuarters&&hpPercent<=.75){boss.hpThresholds.threeQuarters=false;activeMessage={text:'Estabilização falhou...',timer:3e3,opacity:1}}else if(boss.hpThresholds.half&&hpPercent<=.5){boss.hpThresholds.half=false;activeMessage={text:'Instância corrompida demais para reparo...',timer:3e3,opacity:1};player.controlsInverted=true;setTimeout(()=>player.controlsInverted=false,8e3);playSound('anomaly')}else if(boss.hpThresholds.quarter&&hpPercent<=.25){boss.hpThresholds.quarter=false;activeMessage={text:'[ DATA MISSING ]',timer:3e3,opacity:1}}if(p.hits>=p.pierce){projectiles.splice(i,1);continue}}for(let j=enemies.length-1;j>=0;j--){const e=enemies[j];if(p.x>e.x&&p.x<e.x+e.width&&p.y>e.y&&p.y<e.y+e.height){e.hp-=p.damage;p.hits++;if(p.hasCold)e.slowFactor=Math.max(.2,e.slowFactor*0.99);if(e.hp<=0){playSound('enemyDeath');if(enemyStats.onDeath.fragmentation>0)for(let k=0;k<enemyStats.onDeath.fragmentation;k++){const angle=Math.random()*Math.PI*2;projectiles.push({x:e.x+e.width/2,y:e.y+e.height/2,vx:Math.cos(angle)*3,vy:Math.sin(angle)*3,size:5,damage:5,isCrit:false,pierce:1,hits:0,hasCold:false})}if(Math.random()<enemyStats.onDeath.healingOrbChance)orbs.push({x:e.x,y:e.y,type:'heal',value:10});enemies.splice(j,1);gainExp(25)}if(p.hits>=p.pierce){projectiles.splice(i,1);break}}}}
            for(let i=enemies.length-1;i>=0;i--){const e=enemies[i];e.jitter.timer-=deltaTime;if(e.jitter.timer<=0){e.jitter.x=(Math.random()-.5)*4;e.jitter.y=(Math.random()-.5)*4;e.jitter.timer=100+Math.random()*200}if(e.mode==='descending'){e.y+=e.speed*e.slowFactor;if(e.y>=canvas.height*(.4+Math.random()*.3))e.mode='targeting'}else if(e.mode==='targeting'){const angle=Math.atan2(player.y-e.y,player.x-e.x),targetVx=Math.cos(angle)*e.speed*e.slowFactor*0.5,targetVy=Math.sin(angle)*e.speed*e.slowFactor*0.5;e.vx+=(targetVx-e.vx)*0.05;e.vy+=(targetVy-e.vy)*0.05;e.x+=e.vx;e.y+=e.vy;const now=Date.now();if(now-e.lastShot>e.shootCooldown){e.lastShot=now;const pAngle=Math.atan2(player.y-e.y,player.x-e.x);enemyProjectiles.push({x:e.x+e.width/2,y:e.y+e.height/2,vx:Math.cos(pAngle)*5,vy:Math.sin(pAngle)*5,size:8,damage:e.damage})}}if(player.hasOverheat&&!player.invulnerable&&player.x<e.x+e.width&&player.x+player.width>e.x&&player.y<e.y+e.height&&player.y+player.height>e.y){e.hp-=40;takeDamage(e.damage);if(e.hp<=0){enemies.splice(i,1);gainExp(25)}}}
            for(let i=enemyProjectiles.length-1;i>=0;i--){const p=enemyProjectiles[i];p.x+=p.vx;p.y+=p.vy;if(p.x<player.x+player.width&&p.x+p.size>player.x&&p.y<player.y+player.height&&p.y+p.size>player.y){takeDamage(p.damage);enemyProjectiles.splice(i,1);continue}if(p.x<-p.size||p.x>canvas.width+p.size||p.y<-p.size||p.y>canvas.height+p.size)enemyProjectiles.splice(i,1)}
            for(let i=orbs.length-1;i>=0;i--){const o=orbs[i];o.y+=1;if(o.x<player.x+player.width&&o.x>player.x&&o.y<player.y+player.height&&o.y>player.y){if(o.type==='heal')player.hp=Math.min(player.maxHp,player.hp+o.value);orbs.splice(i,1)}if(o.y>canvas.height)orbs.splice(i,1)}
            if(gameSystem.thunderbolt.enabled){gameSystem.thunderbolt.timer-=deltaTime;if(gameSystem.thunderbolt.timer<=0){gameSystem.thunderbolt.timer=gameSystem.thunderbolt.cooldown;for(let i=0;i<gameSystem.thunderbolt.count;i++)if(enemies.length>0){const target=enemies[Math.floor(Math.random()*enemies.length)];particles.push({type:'thunder',x:target.x,y:0,height:target.y,life:20});target.hp-=50;if(target.hp<=0){enemies.splice(enemies.indexOf(target),1);gainExp(25)}}}}
            if(gameSystem.barrier.enabled&&!gameSystem.barrier.ready){gameSystem.barrier.timer-=deltaTime;if(gameSystem.barrier.timer<=0)gameSystem.barrier.ready=true}
            if(activeMessage){activeMessage.timer-=deltaTime;if(activeMessage.timer<=1e3)activeMessage.opacity=activeMessage.timer/1e3;if(activeMessage.timer<=0)activeMessage=null}
            if(anomalyState.isActive){anomalyState.timer-=deltaTime;anomalyState.shadow.x+=anomalyState.shadow.speed*(deltaTime/1000);if(anomalyState.timer<=0)anomalyState.isActive=false}
            if(appState==='gameplay'&&enemies.length===0){gameplayState='wave_transition';gameRunning=false;enemyProjectiles.length=0;levelUp()}
        }
        function draw(){ctx.save();if(glitchIntensity>0){const dx=(Math.random()-.5)*10*glitchIntensity,dy=(Math.random()-.5)*10*glitchIntensity;ctx.translate(dx,dy)}ctx.fillStyle='#0a0a0a';ctx.fillRect(0,0,canvas.width,canvas.height);if(isSystemUnstable||appState==='boss_defeat_outro'||appState==='boss_fight'||appState==='boss_intro'){ctx.save();ctx.globalAlpha=0.08;for(let i=0;i<40;i++){ctx.fillStyle=`rgba(255,255,255,${Math.random()*.4})`;ctx.fillRect(Math.random()*canvas.width,Math.random()*canvas.height,Math.random()*canvas.width/5,Math.random()*2)}if(isSystemUnstable&&Math.random()>.95)drawGlitchText(['prisão','de novo','parar'][Math.floor(Math.random()*3)],Math.random()*canvas.width,Math.random()*canvas.height,Math.random()*.5+.2,24);ctx.restore()}platforms.forEach(p=>{ctx.fillStyle='#444';ctx.fillRect(p.x,p.y,p.width,p.height);if(Math.random()>0.9){ctx.strokeStyle=['#f00','#0f0','#00f'][Math.floor(Math.random()*3)];ctx.lineWidth=1;ctx.strokeRect(p.x+(Math.random()-.5)*3,p.y+(Math.random()-.5)*3,p.width,p.height)}});ctx.save();if(player.invulnerable)ctx.filter='contrast(200%) brightness(150%)';const playerColor=gameSystem.barrier.enabled&&gameSystem.barrier.ready?'#0ff':'#e0e0e0';if(player.controlsInverted)ctx.filter='invert(1)';ctx.fillStyle=playerColor;ctx.fillRect(player.x,player.y,player.width,player.height);ctx.restore();if(player.hasOverheat){ctx.strokeStyle='#ff8800';ctx.lineWidth=2;ctx.strokeRect(player.x-5,player.y-5,player.width+10,player.height+10)}projectiles.forEach(p=>{ctx.fillStyle=p.isCrit?'#ff0':'#f44';ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill()});enemies.forEach(e=>{ctx.fillStyle='#f0f';const jX=e.x+e.jitter.x+(Math.random()-.5)*2,jY=e.y+e.jitter.y+(Math.random()-.5)*2;ctx.fillRect(jX,jY,e.width,e.height);ctx.fillStyle='#555';ctx.fillRect(jX,jY-10,e.width,5);ctx.fillStyle='#f44';ctx.fillRect(jX,jY-10,e.width*(e.hp/e.maxHp),5)});enemyProjectiles.forEach(p=>{ctx.fillStyle='#9400d3';ctx.fillRect(p.x,p.y,p.size,p.size)});orbs.forEach(o=>{ctx.fillStyle='#0f0';ctx.beginPath();ctx.arc(o.x,o.y,8,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#fff';ctx.stroke()});for(let i=particles.length-1;i>=0;i--){const p=particles[i];if(p.type==='thunder'){ctx.strokeStyle='#ff0';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(p.x,p.height);ctx.stroke()}p.life--;if(p.life<=0)particles.splice(i,1)}ctx.restore();if(activeMessage)drawGlitchText(activeMessage.text,player.x+player.width/2,player.y-30,activeMessage.opacity);if(anomalyState.isActive){const p=anomalyState.timer/anomalyState.duration,o=Math.sin(Math.PI*p);ctx.globalCompositeOperation='multiply';ctx.fillStyle=`rgba(0,0,0,${.6*o})`;ctx.fillRect(0,0,canvas.width,canvas.height);ctx.globalCompositeOperation='source-over';ctx.fillStyle=`rgba(255,0,0,${.2*o})`;ctx.fillRect(anomalyState.shadow.x-4,anomalyState.shadow.y,anomalyState.shadow.width,anomalyState.shadow.height);ctx.fillStyle=`rgba(0,255,255,${.2*o})`;ctx.fillRect(anomalyState.shadow.x+4,anomalyState.shadow.y,anomalyState.shadow.width,anomalyState.shadow.height);ctx.shadowColor='#1a001a';ctx.shadowBlur=15;ctx.fillStyle=`rgba(0,0,0,${.85*o})`;ctx.fillRect(anomalyState.shadow.x,anomalyState.shadow.y,anomalyState.shadow.width,anomalyState.shadow.height);ctx.shadowBlur=0;if(anomalyState.timer<anomalyState.duration-200)drawGlitchText(anomalyState.text,canvas.width/2,canvas.height/2,o,32)}if(glitchIntensity>0){ctx.globalCompositeOperation='lighter';const offset=glitchIntensity*4;ctx.drawImage(canvas,offset,0);ctx.globalCompositeOperation='source-over'}if(appState!=='boss_fight'&&appState!=='boss_defeat_outro'&&appState!=='post_boss_cutscene'&&appState!=='boss_intro'&&appState!=='game_over'){document.getElementById('hp-bar').style.width=`${player.hp/player.maxHp*100}%`;document.getElementById('exp-bar').style.width=`${player.exp/player.expToNextLevel*100}%`}}
        function drawGlitchText(text,x,y,baseOpacity,fontSize=18){ctx.font=`${fontSize}px "Courier New"`;ctx.textAlign='center';ctx.fillStyle=`rgba(224,224,224,${baseOpacity*0.9})`;ctx.fillText(text,x+(Math.random()-.5)*4,y+(Math.random()-.5)*4);ctx.fillStyle=`rgba(255,0,0,${baseOpacity*0.3})`;ctx.fillText(text,x-2+(Math.random()-.5)*2,y);ctx.fillStyle=`rgba(0,255,255,${baseOpacity*0.3})`;ctx.fillText(text,x+2+(Math.random()-.5)*2,y);if(Math.random()>0.7){const sX=x+(Math.random()-.5)*100,sY=y+(Math.random()-.5)*20;ctx.fillStyle=`rgba(255,255,255,${Math.random()*.5*baseOpacity})`;ctx.fillRect(sX,sY,Math.random()*30,Math.random()*2)}}
        function updateCutscene(deltaTime){cutsceneState.timer+=deltaTime;cutsceneState.typeTimer+=deltaTime;glitchIntensity=0.2;switch(cutsceneState.phase){case 0:if(cutsceneState.timer>1e3){cutsceneState.phase=1;cutsceneState.typeTimer=0}break;case 1:if(cutsceneState.text1Progress<cutsceneState.text1.length&&cutsceneState.typeTimer>cutsceneState.typeSpeed){cutsceneState.text1Progress++;cutsceneState.typeTimer=0;playSound('beep')}if(cutsceneState.text1Progress>=cutsceneState.text1.length)cutsceneState.phase=2;break;case 2:if(cutsceneState.timer>5e3){cutsceneState.phase=3;cutsceneState.typeTimer=0}break;case 3:if(cutsceneState.text2Progress<cutsceneState.text2.length&&cutsceneState.typeTimer>cutsceneState.typeSpeed){cutsceneState.text2Progress++;cutsceneState.typeTimer=0;playSound('beep')}if(cutsceneState.text2Progress>=cutsceneState.text2.length){cutsceneState.phase=4;cutsceneState.timer=0}break;case 4:if(cutsceneState.timer>4e3){cutsceneState.phase=5;triggerGlitch(2,1500);screenShake=25;setTimeout(startGameplay,1500)}break}}
        function drawCutscene(){ctx.fillStyle='#000';ctx.fillRect(0,0,canvas.width,canvas.height);const pX=canvas.width/2-player.width/2+(Math.random()-.5)*2,pY=canvas.height/2-player.height/2+(Math.random()-.5)*2;ctx.fillStyle='#e0e0e0';ctx.fillRect(pX,pY,player.width,player.height);if(cutsceneState.phase<4){ctx.font='28px "Courier New"';ctx.textAlign='center';ctx.fillStyle='#e0e0e0';ctx.shadowColor='#f0f';ctx.shadowBlur=8;if(cutsceneState.text1Progress>0){const t1=cutsceneState.text1.substring(0,cutsceneState.text1Progress),tX=canvas.width/2+(Math.random()-.5)*4,tY=canvas.height/2-100+(Math.random()-.5)*4;ctx.fillText(t1,tX,tY)}if(cutsceneState.text2Progress>0){const t2=cutsceneState.text2.substring(0,cutsceneState.text2Progress),tX=canvas.width/2+(Math.random()-.5)*4,tY=canvas.height/2-60+(Math.random()-.5)*4;ctx.fillText(t2,tX,tY)}ctx.shadowBlur=0}}
        function startCorruptionCutscene(){appState='corruption_cutscene';corruptionState.status='cutscene';corruptionState.cutsceneTimer=0;corruptionState.currentMessageIndex=0;corruptionState.particles=[];document.getElementById('level-up-screen').style.display='none';document.querySelector('.ui-container').style.display='none';document.querySelector('#wave-indicator').style.display='none';mouse.down=false;playSound('corruption_ambience');for(let i=0;i<50;i++)corruptionState.particles.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,size:Math.random()*4+1,vx:(Math.random()-.5)*.5,vy:(Math.random()-.5)*.5})}
        function updateCorruptionCutscene(deltaTime){corruptionState.cutsceneTimer+=deltaTime;if(corruptionState.cutsceneTimer>(corruptionState.currentMessageIndex+1)*2e3&&corruptionState.currentMessageIndex<corruptionState.cutsceneMessages.length-1)corruptionState.currentMessageIndex++;corruptionState.particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0||p.x>canvas.width)p.vx*=-1;if(p.y<0||p.y>canvas.height)p.vy*=-1});if(corruptionState.cutsceneTimer>12e3)endCorruptionCutscene()}
        function drawCorruptionCutscene(){ctx.fillStyle=`rgba(0,0,0,${Math.min(1,corruptionState.cutsceneTimer/2e3)})`;ctx.fillRect(0,0,canvas.width,canvas.height);ctx.save();ctx.globalAlpha=Math.min(1,(corruptionState.cutsceneTimer-1e3)/2e3);ctx.fillStyle='#e0e0e0';ctx.fillRect(canvas.width/2-player.width/2,canvas.height/2-player.height/2,player.width,player.height);corruptionState.particles.forEach(p=>{ctx.fillStyle=['#f00','#0f0','#00f','#fff'][Math.floor(Math.random()*4)];ctx.fillRect(p.x,p.y,p.size,p.size)});ctx.restore();ctx.font='24px "Courier New"';ctx.textAlign='center';ctx.save();ctx.globalAlpha=Math.sin(corruptionState.cutsceneTimer/500)*.2+.8;for(let i=0;i<=corruptionState.currentMessageIndex;i++)drawGlitchText(corruptionState.cutsceneMessages[i],canvas.width/2,100+i*40,1,24);ctx.restore()}
        function endCorruptionCutscene(){appState='gameplay';gameplayState='wave_transition';corruptionState.status='post_cutscene';corruptionState.wavesRemaining=5;if(corruptionAmbienceSource)corruptionAmbienceSource.stop();document.querySelector('.ui-container').style.display='block';document.querySelector('#wave-indicator').style.display='block';startWaveTransition()}
        function startBossIntro(){appState='boss_intro';gameplayState='playing';gameRunning=true;document.querySelector('.ui-container').style.display='none';document.querySelector('#wave-indicator').style.display='none';enemies.length=0;bossProjectiles.length=0;lasers.length=0;boss=null;bossIntroState.timer=0;bossIntroState.materializeTimer=0;playSound('pre_boss_hum')}
        function updateBossIntro(deltaTime){bossIntroState.timer+=deltaTime;if(bossIntroState.timer>bossIntroState.duration){if(!boss){playSound('boss_materialize');boss={x:canvas.width/2-40,y:100,width:80,height:120,hp:5e3,maxHp:5e3,attackTimer:3500,attackCooldown:3500,hpThresholds:{threeQuarters:true,half:true,quarter:true},deathTimer:null,deathParticles:[],isDashing:false,isPreDashing:false,dashTargetX:0,dashTargetY:0,dashTimer:0,vx:1,vy:.5,isVulnerable:false,vulnerableTimer:0}};bossIntroState.materializeTimer+=deltaTime;if(bossIntroState.materializeTimer>bossIntroState.materializeDuration){appState='boss_fight';if(corruptionAmbienceSource)corruptionAmbienceSource.stop();playSound('corruption_ambience')}}}
        function drawBossIntro(){ctx.fillStyle='#0a0a0a';ctx.fillRect(0,0,canvas.width,canvas.height);draw();if(boss){const p=bossIntroState.materializeTimer/bossIntroState.materializeDuration;ctx.globalAlpha=p;drawBossFight();ctx.globalAlpha=1}}
        function startBossFight(){appState='boss_fight';gameplayState='playing';gameRunning=true;document.querySelector('.ui-container').style.display='none';document.querySelector('#wave-indicator').style.display='none';enemies.length=0;bossProjectiles.length=0;lasers.length=0;boss={x:canvas.width/2-40,y:100,width:80,height:120,hp:5e3,maxHp:5e3,attackTimer:3500,attackCooldown:3500,phase:1,hpThresholds:{threeQuarters:true,half:true,quarter:true},deathTimer:null,deathParticles:[],isDashing:false,isPreDashing:false,dashTargetX:0,dashTargetY:0,dashTimer:0,vx:1,vy:.5,isVulnerable:false,vulnerableTimer:0};playSound('corruption_ambience')}
        function updateBossFight(deltaTime){if(!boss||boss.deathTimer!==null){if(boss&&boss.deathTimer!==null){boss.deathTimer-=deltaTime;if(boss.deathTimer<=0){appState='post_boss_cutscene';if(corruptionAmbienceSource)corruptionAmbienceSource.stop();playSound('post_boss_ambience');}}return}boss.attackTimer-=deltaTime;if(boss.isVulnerable){boss.vulnerableTimer-=deltaTime;if(boss.vulnerableTimer<=0)boss.isVulnerable=false}if(boss.isDashing){boss.dashTimer-=deltaTime;const dx=boss.dashTargetX-boss.x,dy=boss.dashTargetY-boss.y,dist=Math.sqrt(dx*dx+dy*dy);if(dist>25){boss.x+=dx/dist*25;boss.y+=dy/dist*25}else{boss.isDashing=false;boss.isVulnerable=true;boss.vulnerableTimer=1500}particles.push({x:boss.x+boss.width/2,y:boss.y+boss.height/2,size:20,life:200,color:'rgba(255,0,255,0.5)'});if(boss.dashTimer<=0){boss.isDashing=false;boss.isVulnerable=true;boss.vulnerableTimer=1500}}else if(boss.isPreDashing){boss.dashTimer-=deltaTime;if(boss.dashTimer<=0){boss.isPreDashing=false;boss.isDashing=true;boss.dashTimer=500}}else{boss.x+=boss.vx;boss.y+=boss.vy;if(boss.x<0||boss.x+boss.width>canvas.width)boss.vx*=-1;if(boss.y<50||boss.y+boss.height>canvas.height/2)boss.vy*=-1}if(boss.attackTimer<=0&&!boss.isDashing&&!boss.isPreDashing){const attackChoice=Math.random();if(attackChoice<.4){for(let i=0;i<36;i++){const angle=(i/36)*Math.PI*2+Math.random()*.1;bossProjectiles.push({x:boss.x+boss.width/2,y:boss.y+boss.height/2,vx:Math.cos(angle)*4,vy:Math.sin(angle)*4,size:10,damage:10,trail:[]})}}else if(attackChoice<.7){const type=['h','v','d'][Math.floor(Math.random()*3)];let x1,y1,x2,y2;if(type==='h'){y1=y2=Math.random()*canvas.height;x1=0;x2=canvas.width}else if(type==='v'){x1=x2=Math.random()*canvas.width;y1=0;y2=canvas.height}else{x1=0;y1=Math.random()*canvas.height;x2=canvas.width;y2=Math.random()*canvas.height}lasers.push({x1:x1,y1:y1,x2:x2,y2:y2,life:1e3,active:false})}else{boss.isPreDashing=true;boss.dashTargetX=player.x;boss.dashTargetY=player.y;boss.dashTimer=1e3;playSound('boss_dash_charge')}boss.attackTimer=boss.attackCooldown}bossProjectiles.forEach((p,i)=>{p.x+=p.vx;p.y+=p.vy;p.trail.push({x:p.x,y:p.y});if(p.trail.length>5)p.trail.shift();if(p.x<player.x+player.width&&p.x+p.size>player.x&&p.y<player.y+player.height&&p.y+p.size>player.y){takeDamage(p.damage);bossProjectiles.splice(i,1)}});lasers.forEach((l,i)=>{l.life-=deltaTime;if(l.life<=0&&!l.active){l.active=true;l.life=200;playSound('anomaly')}if(l.life<=0&&l.active)lasers.splice(i,1);if(l.active){const dx=l.x2-l.x1,dy=l.y2-l.y1,lenSq=dx*dx+dy*dy;let t=((player.x+player.width/2-l.x1)*dx+(player.y+player.height/2-l.y1)*dy)/lenSq;t=Math.max(0,Math.min(1,t));const closestX=l.x1+t*dx,closestY=l.y1+t*dy;const distSq=Math.pow(player.x+player.width/2-closestX,2)+Math.pow(player.y+player.height/2-closestY,2);if(distSq<Math.pow(10+player.width/2,2))takeDamage(2)}});if(boss.hp<=0&&boss.deathTimer===null){if(corruptionAmbienceSource)corruptionAmbienceSource.stop();boss.deathTimer=5e3;playSound('enemyDeath');for(let i=0;i<200;i++)boss.deathParticles.push({x:boss.x+boss.width/2,y:boss.y+boss.height/2,vx:(Math.random()-.5)*8,vy:(Math.random()-.5)*8,size:Math.random()*8+2,life:5e3,opacity:1})}}
        function drawBossFight(){if(!boss)return;if(boss.deathTimer!==null){ctx.globalAlpha=boss.deathTimer/5e3;boss.deathParticles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.life-=16;p.opacity=p.life/5e3;ctx.fillStyle=`rgba(255,0,255,${p.opacity})`;ctx.fillRect(p.x,p.y,p.size,p.size)});if(boss.deathTimer<2e3)drawGlitchText("Instância encerrada... mas não deletada.",canvas.width/2,canvas.height/2,1-boss.deathTimer/2e3,32);ctx.globalAlpha=1}else{drawGlitchText("Instância Anômala: Processo Corrompido",canvas.width/2,30,1,28);ctx.fillStyle="rgba(150,0,0,0.8)";ctx.fillRect(canvas.width/4,50,canvas.width/2,20);ctx.fillStyle="rgba(255,0,0,0.8)";ctx.fillRect(canvas.width/4,50,canvas.width/2*(boss.hp/boss.maxHp),20);ctx.save();if(boss.isPreDashing)ctx.filter='brightness(200%)';if(boss.isVulnerable){ctx.shadowColor='#00ffff';ctx.shadowBlur=20}ctx.fillStyle=boss.isVulnerable?'#00ffff':"rgba(10,0,10,0.8)";ctx.fillRect(boss.x,boss.y,boss.width,boss.height);ctx.restore();for(let i=0;i<15;i++){ctx.fillStyle=`rgba(255,255,255,${Math.random()*.5})`;const w=Math.random()*40,h=Math.random()*40;ctx.fillRect(boss.x+boss.width/2+(Math.random()-.5)*120-w/2,boss.y+boss.height/2+(Math.random()-.5)*160-h/2,w,h)}}bossProjectiles.forEach(p=>{p.trail.forEach((t,i)=>{ctx.fillStyle=`rgba(255,0,255,${.1*i})`;ctx.beginPath();ctx.arc(t.x,t.y,p.size*.5,0,Math.PI*2);ctx.fill()});ctx.fillStyle="#f0f";ctx.beginPath();ctx.arc(p.x,p.y,p.size*.7,0,Math.PI*2);ctx.fill()});ctx.save();lasers.forEach(l=>{if(!l.active){ctx.lineWidth=2;ctx.strokeStyle=`rgba(255,0,0,${Math.random()})`;ctx.beginPath();ctx.moveTo(l.x1,l.y1);ctx.lineTo(l.x2,l.y2);ctx.stroke()}else{ctx.lineWidth=20;ctx.strokeStyle=`rgba(255,100,100,${Math.random()*.5+.5})`;ctx.beginPath();ctx.moveTo(l.x1,l.y1);ctx.lineTo(l.x2,l.y2);ctx.stroke();if(Math.random()>.5){const x=Math.random()*canvas.width,y=Math.random()*canvas.height;ctx.fillStyle='rgba(255,255,255,0.1)';ctx.fillRect(x,y,2,Math.random()*50)}}});ctx.restore();const barWidth=200,barHeight=20,x=20,y=canvas.height-40;ctx.save();ctx.shadowColor='#ff00ff';ctx.shadowBlur=10;drawGlitchText('HP',x+barWidth/2,y-15,1);ctx.strokeStyle='rgba(255,255,255,0.8)';ctx.strokeRect(x+(Math.random()-.5)*2,y+(Math.random()-.5)*2,barWidth,barHeight);ctx.restore();const hpRatio=player.hp/player.maxHp;for(let i=0;i<barWidth*hpRatio;i+=4){for(let j=0;j<barHeight;j+=4){if(Math.random()>.3){ctx.fillStyle=`rgba(255,65,65,${.5+Math.random()*.5})`;ctx.fillRect(x+i+Math.random()*2-1,y+j+Math.random()*2-1,2,2)}}}ctx.fillStyle='rgba(255,100,100,0.2)';ctx.fillRect(x,y,barWidth*hpRatio,barHeight)}
        function startGameplay(){appState='gameplay';player.x=canvas.width/2;player.y=GROUND_Y-player.height;player.vy=0;document.querySelector('.ui-container').style.display='block';document.querySelector('#wave-indicator').style.display='block';startNextWave();lastTime=performance.now()}
        function triggerGlitch(intensity,duration){glitchIntensity=intensity;setTimeout(()=>glitchIntensity=0,duration)}
        function applyScreenShake(){if(screenShake>0){const sX=(Math.random()-.5)*screenShake,sY=(Math.random()-.5)*screenShake;canvas.style.transform=`translate(${sX}px, ${sY}px)`;screenShake*=.9;if(screenShake<0.5)screenShake=0}else canvas.style.transform='translate(0,0)'}
        let lastTime=0;
        function gameLoop(timestamp){if(!lastTime)lastTime=timestamp;const deltaTime=timestamp-lastTime;lastTime=timestamp;
            if (appState === 'start_screen') { ctx.fillStyle='#000';ctx.fillRect(0,0,canvas.width,canvas.height); drawGlitchText('Clique para começar', canvas.width/2, canvas.height/2, 1, 48); } 
            else if (appState === 'cutscene') { updateCutscene(deltaTime); drawCutscene(); } 
            else if (appState === 'debug_menu') { drawDebugMenu(); }
            else if (appState === 'corruption_cutscene') { updateCorruptionCutscene(deltaTime); drawCorruptionCutscene(); }
            else if (appState === 'post_boss_cutscene') { updatePostBossCutscene(deltaTime); drawPostBossCutscene(); }
            else if (appState === 'system_collapse') { updateSystemCollapse(deltaTime); drawSystemCollapse(); }
            else if (appState === 'boss_intro') { updateBossIntro(deltaTime); drawBossIntro(); }
            else if (appState === 'boss_fight' || appState === 'boss_defeat_outro') { update(deltaTime); updateBossFight(deltaTime); draw(); drawBossFight(); }
            else if (appState === 'gameplay') { update(deltaTime); draw(); }
            else if (appState === 'game_over') { drawGameOver(); }
            applyScreenShake(); requestAnimationFrame(gameLoop);
        }
        function drawGameOver(){ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(0,0,canvas.width,canvas.height);drawGlitchText("SIGNAL LOST",canvas.width/2,canvas.height/2,1,60);drawGlitchText("Refresh to try again",canvas.width/2,canvas.height/2+50,1,24)}
        function drawDebugMenu(){ctx.fillStyle='#000';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.strokeStyle='#fff';ctx.lineWidth=2;for(let i=0;i<5;i++)ctx.strokeRect(40+(Math.random()-.5)*8,40+(Math.random()-.5)*8,canvas.width-80,canvas.height-80);drawGlitchText('// DEBUG MENU //',canvas.width/2,80,1,48);if(debugMenu.mode==='main'){const waveText=debugMenu.startWave===10?'WAVE: BOSS':'WAVE: '+debugMenu.startWave;const options=['START GAME',waveText,'GIVE CARDS'];options.forEach((opt,i)=>{let opacity=debugMenu.selectedIndex===i?1:.5;drawGlitchText(opt,canvas.width/2,200+i*80,opacity,32)})}else if(debugMenu.mode==='card_list'){drawGlitchText('APPLY UPGRADES [J] - BACK [K]',canvas.width/2,120,1,24);const visibleCount=12;if(debugMenu.cardIndex<debugMenu.cardScrollOffset)debugMenu.cardScrollOffset=debugMenu.cardIndex;if(debugMenu.cardIndex>=debugMenu.cardScrollOffset+visibleCount)debugMenu.cardScrollOffset=debugMenu.cardIndex-visibleCount+1;for(let i=0;i<visibleCount;i++){const index=debugMenu.cardScrollOffset+i;if(index>=allCards.length)break;const card=allCards[index];let color=player.debugAppliedCards.has(card.name)?'#0f0':'#fff';let opacity=debugMenu.cardIndex===index?1:.6;ctx.fillStyle=`rgba(${color==='#0f0'?'0,255,0':'255,255,255'}, ${opacity})`;ctx.textAlign='left';ctx.font='24px "Courier New"';ctx.fillText((debugMenu.cardIndex===index?'> ':'  ')+card.name,150,180+i*30)}}}
        function updatePostBossCutscene(deltaTime){postBossCutscene.timer+=deltaTime;if(postBossCutscene.currentLine<postBossCutscene.textLines.length){if(postBossCutscene.textProgress<postBossCutscene.textLines[postBossCutscene.currentLine].length*postBossCutscene.typeSpeed){postBossCutscene.textProgress+=deltaTime;if(Math.floor(postBossCutscene.textProgress/postBossCutscene.typeSpeed)>Math.floor((postBossCutscene.textProgress-deltaTime)/postBossCutscene.typeSpeed))playSound('beep')}else{if(postBossCutscene.timer>3e3){postBossCutscene.currentLine++;postBossCutscene.timer=0;postBossCutscene.textProgress=0}}}else if(postBossCutscene.timer>4e3){if(corruptionAmbienceSource)corruptionAmbienceSource.stop();appState='system_collapse';startSystemCollapse()}}
        function drawPostBossCutscene(){ctx.fillStyle='#000';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.save();ctx.globalAlpha=0.8;ctx.fillStyle='#e0e0e0';ctx.fillRect(canvas.width/2-player.width/2,canvas.height/2-player.height/2,player.width,player.height);for(let i=0;i<30;i++){ctx.fillStyle=`rgba(255,255,255,${Math.random()*.4})`;ctx.fillRect(Math.random()*canvas.width,Math.random()*canvas.height,Math.random()*2,Math.random()*50)}ctx.restore();if(postBossCutscene.currentLine<postBossCutscene.textLines.length){const line=postBossCutscene.textLines[postBossCutscene.currentLine];const textToDraw=line.substring(0,Math.floor(postBossCutscene.textProgress/postBossCutscene.typeSpeed));drawGlitchText(textToDraw,canvas.width/2,100,1,28)}}
        function startSystemCollapse(){systemCollapseState.active=true;systemCollapseState.timer=0;systemCollapseState.debris=[];playSound('system_collapse')}
        function updateSystemCollapse(deltaTime){systemCollapseState.timer+=deltaTime;glitchIntensity=3;screenShake=15;if(systemCollapseState.timer<1e4){systemCollapseState.fakeWave+=Math.floor(Math.random()*99)}for(let i=0;i<10;i++)systemCollapseState.debris.push({x:Math.random()*canvas.width,y:-20,width:Math.random()*5+1,height:Math.random()*40+10,speed:Math.random()*15+5,char:String.fromCharCode(Math.random()*93+33)});systemCollapseState.debris.forEach((d,i)=>{d.y+=d.speed;if(d.y>canvas.height)systemCollapseState.debris.splice(i,1)})}
        function drawSystemCollapse(){ctx.fillStyle='#000';ctx.fillRect(0,0,canvas.width,canvas.height);systemCollapseState.debris.forEach(d=>{ctx.fillStyle=`rgba(255,255,255,${Math.random()*.5})`;ctx.fillRect(d.x,d.y,d.width,d.height)});const waveText=systemCollapseState.timer<1e4?`WAVE ${systemCollapseState.fakeWave}`:corruptText("WAVE "+systemCollapseState.fakeWave);drawGlitchText(waveText,canvas.width/2,40,1,32);if(systemCollapseState.timer>14e3)ctx.fillStyle=`rgba(0,0,0,${(systemCollapseState.timer-14e3)/1e3})`;ctx.fillRect(0,0,canvas.width,canvas.height)}
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>